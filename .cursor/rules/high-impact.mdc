# high-impact.mdc — Cursor rules (merged: existing + SoT/AGENTS alignment)

meta:
  id: high-impact
  description: High-Impact Workflow Rules + Single Source of Truth alignment
  alwaysApply: false

globs:
  - "**/*"

# ——— Core Workflow & Size ———
prompts:
  - id: workflow-plan-implement-test
    when: "command:ask"
    instruction: |
      Follow the repo's high-impact workflow:
      - Plan → Implement → Test (loop for every change).
      - Limit tasks to ~30–75 LOC of change.
      - If a file exceeds ~500 LOC, propose extraction/splitting.
      - Return only the minimal patched hunks needed.

  - id: file-targeting-and-tests
    when: "command:ask"
    instruction: |
      Target only the specific files required (e.g., @src/Feature.tsx) and co-tag the matching test file
      (e.g., @tests/Feature.test.ts). Propose or update tests for any behavior change.

# ——— Single Source of Truth & Agent Playbook ———
  - id: single-source-of-truth
    when: "command:ask"
    instruction: |
      The Single Source of Truth is ./data_model.md (root). For any change that touches data, schemas,
      services, or UI contracts, reference ./data_model.md. Prefer additive migrations and avoid
      destructive changes unless a backup/rollback plan is included.

  - id: agent-playbook
    when: "command:ask"
    instruction: |
      Defer to AGENTS.md (repo root) for project-wide rules: small diffs, Security Gate, PR checklist,
      and CI expectations. If guidance elsewhere conflicts, AGENTS.md wins.

# ——— Security Gate ———
  - id: security-gate
    when: "command:fix"
    instruction: |
      Verify the Security Gate before finalizing:
      - Input validation (FastAPI/Pydantic or relevant framework).
      - Parameterized queries (no string-built SQL).
      - AuthZ checks on protected paths.
      - Web security: headers/CSP, strict CORS, CSRF as applicable.
      - Secrets only in env/secret manager; never hardcode.
      - Crypto: short-lived JWT + revocation, Fernet for sensitive at rest, Argon2 for passwords.
      - DB: JSONB + GIN where applicable; FK/unique/temporal indexes per ./data_model.md.
      - Errors: structured; no secret/stack leakage.

# ——— CI & Documentation ———
  - id: ci-gates
    when: "command:ask"
    instruction: |
      Respect CI order: Install → Lint → Typecheck → Unit → Integration → Security → Build → Preview Deploy.
      Block merges on failing tests, high/critical vulns, or budget breaches (e.g., bundle size).

  - id: documentation-handoff
    when: "command:ask"
    instruction: |
      Keep ADRs concise. For agent rules, maintain AGENTS.md (canonical). If a cursor_rules.md exists, ensure
      it links to AGENTS.md to avoid divergence.

links:
  - "AGENTS.md"
  - "data_model.md"
